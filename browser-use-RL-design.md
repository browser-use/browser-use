# Browser-Use å¼ºåŒ–å­¦ä¹ ç³»ç»Ÿè®¾è®¡æ–‡æ¡£

## ä¸€ã€ç³»ç»Ÿæ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯
åŸBrowser-Useé¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäºLLMçš„æµè§ˆå™¨è‡ªåŠ¨åŒ–æ¡†æ¶ï¼Œä½†å­˜åœ¨ä¸€ä¸ªå…³é”®é—®é¢˜ï¼šLLMæ¯æ¬¡åšå†³ç­–éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œæ— æ³•ä»è¿‡å»çš„æˆåŠŸå’Œå¤±è´¥ä¸­å­¦ä¹ ã€‚è¿™å¯¼è‡´ç›¸åŒçš„é”™è¯¯å¯èƒ½é‡å¤å‡ºç°ï¼Œè€Œæœ‰æ•ˆçš„ç­–ç•¥ä¹Ÿæ— æ³•è¢«å¤ç”¨ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¼•å…¥å¼ºåŒ–å­¦ä¹ æœºåˆ¶ï¼Œé€šè¿‡è®°å½•ã€è¯„åˆ†å’Œæ£€ç´¢å†å²æ‰§è¡Œç»éªŒï¼Œä½¿agentèƒ½å¤Ÿåœ¨é¢å¯¹ç›¸ä¼¼æƒ…å†µæ—¶å‚è€ƒè¿‡å»çš„æˆåŠŸç»éªŒï¼Œä»è€Œæé«˜ä»»åŠ¡å®Œæˆç‡å’Œæ‰§è¡Œæ•ˆç‡ã€‚

### 1.2 æ ¸å¿ƒæ€æƒ³
ç³»ç»Ÿé€šè¿‡ä¸‰ä¸ªå…³é”®æ­¥éª¤å®ç°ç»éªŒå­¦ä¹ ï¼šé¦–å…ˆè®°å½•æ¯æ¬¡ä»»åŠ¡æ‰§è¡Œçš„å®Œæ•´è¿‡ç¨‹ï¼ˆåŒ…æ‹¬æµè§ˆå™¨çŠ¶æ€ã€å¯ç”¨å·¥å…·ã€agentå†³ç­–ç­‰ï¼‰ï¼Œç„¶åå¯¹æ¯ä¸ªåŠ¨ä½œçš„æ•ˆæœè¿›è¡Œè¯„åˆ†ï¼ˆ-5åˆ°+5ï¼‰ï¼Œæœ€ååœ¨æ–°çš„ä»»åŠ¡æ‰§è¡Œä¸­é€šè¿‡çŠ¶æ€ç›¸ä¼¼åº¦æ£€ç´¢ç›¸å…³çš„å†å²ç»éªŒï¼Œå°†é«˜åˆ†ç»éªŒä½œä¸ºå‚è€ƒä¿¡æ¯æä¾›ç»™LLMï¼ŒæŒ‡å¯¼å…¶åšå‡ºæ›´å¥½çš„å†³ç­–ã€‚è¿™ç§æ–¹å¼ä¸æ”¹å˜LLMçš„å†³ç­–æœºåˆ¶ï¼Œè€Œæ˜¯é€šè¿‡æä¾›æ›´ä¸°å¯Œçš„ä¸Šä¸‹æ–‡ä¿¡æ¯æ¥æå‡å†³ç­–è´¨é‡ã€‚

### 1.3 æ•´ä½“æ¶æ„
- æ•°æ®æ”¶é›†å±‚
- æ•°æ®å¤„ç†å±‚  
- æ£€ç´¢å¢å¼ºå±‚
- åœ¨çº¿åº”ç”¨å±‚

## äºŒã€æ•°æ®æ”¶é›†å±‚

### 2.1 åŸå§‹æ—¥å¿—å¢å¼º

#### 2.1.1 TXTæ—¥å¿—æ ¼å¼å¢å¼º
åŸé¡¹ç›®çš„TXTæ—¥å¿—è®°å½•äº†æ¯ä¸ªæ­¥éª¤çš„å®Œæ•´å¯¹è¯ï¼Œä½†ç¼ºå°‘äº†ä¸€ä¸ªå…³é”®ä¿¡æ¯ï¼š**LLMåœ¨å½“å‰æ­¥éª¤å¯ç”¨çš„å·¥å…·åˆ—è¡¨**ã€‚è¿™ä¸ªä¿¡æ¯å¯¹äºå¼ºåŒ–å­¦ä¹ ç³»ç»Ÿè‡³å…³é‡è¦ï¼Œå› ä¸ºå®ƒè®°å½•äº†LLMåœ¨ç‰¹å®šçŠ¶æ€ä¸‹çš„å†³ç­–ç©ºé—´ï¼Œå¸®åŠ©æˆ‘ä»¬ç†è§£ï¼š
- LLMä»å“ªäº›å·¥å…·ä¸­è¿›è¡Œé€‰æ‹©
- æŸä¸ªå†³ç­–æ˜¯å¦åˆç†ï¼ˆæ˜¯å¦é€‰æ‹©äº†æœ€åˆé€‚çš„å·¥å…·ï¼‰
- åœ¨ç›¸ä¼¼çŠ¶æ€ä¸‹ï¼Œå†å²ç»éªŒä¸­å“ªäº›å·¥å…·æ˜¯å¯ç”¨çš„

**æŠ€æœ¯å®ç°ï¼š**

1. **æ•°æ®è·å–ä½ç½®**ï¼šåœ¨`browser_use/agent/service.py`çš„`get_next_action`æ–¹æ³•ä¸­
2. **è·å–é€»è¾‘**ï¼šä»`self.ActionModel.model_fields`ä¸­æå–å·¥å…·åç§°å’Œæè¿°
3. **å­˜å‚¨æ–¹å¼**ï¼šé€šè¿‡`self._last_tools_description`å®ä¾‹å˜é‡ä¿å­˜
4. **è¾“å‡ºæ ¼å¼**ï¼šåœ¨`browser_use/agent/message_manager/utils.py`çš„`_format_conversation_full`æ–¹æ³•ä¸­æ·»åŠ 

**å…·ä½“ä»£ç é€»è¾‘ï¼š**
```python
# åœ¨get_next_actionä¸­è·å–å·¥å…·æè¿°
if hasattr(self, 'ActionModel') and hasattr(self.ActionModel, 'model_fields'):
    tools_desc = []
    for tool_name, tool_field in self.ActionModel.model_fields.items():
        if tool_field.description:
            tools_desc.append(f"{tool_name}: {tool_field.description}")
    self._last_tools_description = '\n'.join(tools_desc) if tools_desc else None
```

**æ—¥å¿—æ ¼å¼å¢å¼ºæ•ˆæœï¼š**
```
 AVAILABLE TOOLS/ACTIONS 
click_element: Click on an element
input_text: Input text into an element
scroll_page: Scroll the page
navigate_to_url: Navigate to a URL
done: Complete the task

 SystemMessage 
[ç³»ç»Ÿæç¤ºè¯å†…å®¹]

 HumanMessage 
[ç”¨æˆ·ä»»åŠ¡å’Œæµè§ˆå™¨çŠ¶æ€]

 RAW LLM OUTPUT 
[LLMåŸå§‹è¾“å‡º]

 RESPONSE
[è§£æåçš„agentè¾“å‡º]
```

#### 2.1.2 JSONæ—¥å¿—ç»“æ„åŒ–å­˜å‚¨
åŸé¡¹ç›®é€šè¿‡`AgentJSONLogger`ç±»å®ç°äº†ç»“æ„åŒ–çš„JSONæ—¥å¿—å­˜å‚¨ï¼Œå°†ä¸€æ¬¡å®Œæ•´çš„agentä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¿å­˜ä¸ºå•ä¸ªJSONæ–‡ä»¶ã€‚è¿™ç§è®¾è®¡å·²ç»å¾ˆå®Œå–„ï¼ŒåŒ…å«äº†å¼ºåŒ–å­¦ä¹ æ‰€éœ€çš„å¤§éƒ¨åˆ†å…³é”®ä¿¡æ¯ã€‚

**å½“å‰JSONç»“æ„ç¤ºä¾‹ï¼š**
```json
{
  "session_info": {
    "session_id": "session_name_timestamp",
    "start_time": "2025-01-15T10:30:00.123456",
    "end_time": "2025-01-15T10:35:30.789012", 
    "total_steps": 12,
    "success": true,
    "task": "ç”¨æˆ·ä»»åŠ¡æè¿°"
  },
  "steps": [
    {
      "step_number": 1,
      "timestamp": "2025-01-15T10:30:05.456789",
      "dom_state": {
        "url": "https://example.com",
        "title": "é¡µé¢æ ‡é¢˜",
        "scroll_position": {"pixels_above": 0, "pixels_below": 800},
        "tabs": [{"page_id": "page_123", "url": "https://example.com", "title": "é¡µé¢æ ‡é¢˜"}],
        "interactive_elements_text": "å¯äº¤äº’å…ƒç´ çš„æ–‡æœ¬æè¿°",
        "has_screenshot": true
      },
      "agent_response": {
        "thinking": "æˆ‘éœ€è¦ç‚¹å‡»ç™»å½•æŒ‰é’®",
        "evaluation_previous_goal": "æˆåŠŸå¯¼èˆªåˆ°äº†ç™»å½•é¡µé¢", 
        "memory": "å·²ç»åˆ°è¾¾ç™»å½•é¡µé¢",
        "next_goal": "ç‚¹å‡»ç™»å½•æŒ‰é’®",
        "action": [{"action_type": "click_element", "parameters": {"index": 5}}]
      }
    }
  ]
}
```

**å·²åŒ…å«çš„æ ¸å¿ƒä¿¡æ¯ï¼š**
- **ä»»åŠ¡ä¸Šä¸‹æ–‡**ï¼štaskæè¿°ã€successçŠ¶æ€ã€æ‰§è¡Œæ—¶é—´
- **å†³ç­–è¿‡ç¨‹**ï¼šthinkingæ¨ç†ã€next_goalç›®æ ‡ã€actionåŠ¨ä½œ
- **ç¯å¢ƒçŠ¶æ€**ï¼šurlã€é¡µé¢å…ƒç´ ã€æ»šåŠ¨ä½ç½®ã€æ ‡ç­¾é¡µä¿¡æ¯
- **æ‰§è¡Œè½¨è¿¹**ï¼šstep_numberã€timestampã€evaluationåé¦ˆ


### 2.2 å…³é”®æ•°æ®ç»“æ„
- ä¼šè¯(Session)æ•°æ®æ¨¡å‹
- æ­¥éª¤(Step)æ•°æ®æ¨¡å‹
- çŠ¶æ€(State)è¡¨ç¤ºæ–¹æ³•

## ä¸‰ã€æ•°æ®å¤„ç†å±‚

### 3.1 åŠ¨ä½œè¯„åˆ†ç³»ç»Ÿ

åŠ¨ä½œè¯„åˆ†ç³»ç»Ÿé€šè¿‡`ActionScorer`ç±»å®ç°ï¼Œè´Ÿè´£å¯¹å·²å®Œæˆä»»åŠ¡çš„æ¯ä¸ªæ­¥éª¤è¿›è¡Œè´¨é‡è¯„ä¼°ï¼Œä¸ºå¼ºåŒ–å­¦ä¹ æä¾›è®­ç»ƒä¿¡å·ã€‚

#### 3.1.1 è¯„åˆ†æ ‡å‡†è®¾è®¡
é‡‡ç”¨**-5åˆ°+5**çš„æ•´æ•°è¯„åˆ†ä½“ç³»ï¼Œå…±11ä¸ªåˆ†å€¼çº§åˆ«ï¼š

**æ­£å‘è¯„åˆ†ï¼š**
- **+5**: å®Œç¾åŠ¨ä½œ - ç›´æ¥è§£å†³æ ¸å¿ƒé—®é¢˜æˆ–å®ç°ä¸»è¦ç›®æ ‡
- **+4**: ä¼˜ç§€åŠ¨ä½œ - é‡å¤§çªç ´æˆ–å…³é”®è¿›å±•
- **+3**: è‰¯å¥½åŠ¨ä½œ - æ˜ç¡®çš„æ­£å‘è¿›å±•
- **+2**: æœ‰ç”¨åŠ¨ä½œ - åˆç†çš„å¸¸è§„æ­¥éª¤
- **+1**: è½»å¾®å¸®åŠ© - å°å¹…è¿›å±•æˆ–å‡†å¤‡åŠ¨ä½œ

**ä¸­æ€§è¯„åˆ†ï¼š**
- **0**: æ— å½±å“ - æ—¢ä¸å¸®åŠ©ä¹Ÿä¸é˜»ç¢

**è´Ÿå‘è¯„åˆ†ï¼š**
- **-1**: è½»å¾®æµªè´¹ - æ— å®³ä½†ä¸å¿…è¦
- **-2**: ä½æ•ˆåŠ¨ä½œ - æµªè´¹æ—¶é—´æˆ–èµ„æº
- **-3**: é”™è¯¯åŠ¨ä½œ - æ˜æ˜¾çš„é”™è¯¯é€‰æ‹©
- **-4**: æœ‰å®³åŠ¨ä½œ - é€ æˆé—®é¢˜æˆ–å€’é€€
- **-5**: ä¸¥é‡å¤±è´¥ - é‡å¤§é˜»ç¢

#### 3.1.2 è¯„åˆ†å®ç°ç‰¹ç‚¹
- **å…¨å±€è§†è§’è¯„åˆ†**ï¼šä¸€æ¬¡æ€§è¯„ä¼°æ•´ä¸ªä»»åŠ¡æµç¨‹ï¼Œç†è§£æ­¥éª¤é—´çš„ä¾èµ–å…³ç³»
- **æ‰¹é‡å¤„ç†**ï¼šå•æ¬¡APIè°ƒç”¨è¯„åˆ†æ‰€æœ‰æ­¥éª¤ï¼Œæé«˜æ•ˆç‡å’Œä¸€è‡´æ€§
- **ç»“æ„åŒ–è¾“å‡º**ï¼šåŒ…å«åˆ†æ•°(score)ã€ç†ç”±(reasoning)ã€æƒ…å¢ƒæè¿°(situation)
- **éªŒè¯æœºåˆ¶**ï¼šè‡ªåŠ¨æ£€æŸ¥åˆ†æ•°èŒƒå›´ï¼Œå¤„ç†å¼‚å¸¸æƒ…å†µ

#### 3.1.3 è¯„åˆ†æ•°æ®ç»“æ„
```json
{
  "task_analysis": "æ•´ä½“ä»»åŠ¡æ‰§è¡Œåˆ†æ",
  "scored_steps": [
    {
      "step_number": 1,
      "scores": {
        "step_score": 3,
        "overall_reasoning": "è¯¥åŠ¨ä½œæˆåŠŸå®šä½åˆ°ç›®æ ‡é¡µé¢",
        "situation": "åœ¨Googleæœç´¢é¡µé¢ï¼Œæœç´¢æ¡†å’ŒæŒ‰é’®å¯è§"
      }
    }
  ]
}
```

#### 3.1.4 æŠ€æœ¯å®ç°
- ä½¿ç”¨LangChainçš„ChatOpenAIæ¥å£
- æ”¯æŒå¤šç§LLMæ¨¡å‹ï¼ˆé»˜è®¤gpt-4o-miniï¼‰
- è¯¦ç»†çš„æç¤ºè¯å·¥ç¨‹ç¡®ä¿è¯„åˆ†ä¸€è‡´æ€§
- å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•

### 3.2 çŠ¶æ€åµŒå…¥ç”Ÿæˆ

çŠ¶æ€åµŒå…¥ç³»ç»Ÿé€šè¿‡`StateEmbedder`æ¨¡å—å®ç°ï¼Œå°†DOMçŠ¶æ€è½¬æ¢ä¸ºå‘é‡è¡¨ç¤ºï¼Œä¸ºåç»­çš„ç›¸ä¼¼ç»éªŒæ£€ç´¢æä¾›åŸºç¡€ã€‚

#### 3.2.1 çŠ¶æ€è¡¨ç¤ºæ–¹æ¡ˆ
ä»DOMçŠ¶æ€ä¸­æå–å…³é”®ä¿¡æ¯æ„å»ºæ–‡æœ¬è¡¨ç¤ºï¼š
```
URL: {url}
Page Title: {title}
Interactive Elements: {interactive_elements}
Scroll Position: {pixels_above} pixels above, {pixels_below} pixels below
```

**é€‰æ‹©è¿™äº›ç‰¹å¾çš„åŸå› ï¼š**
- **URL**ï¼šæ ‡è¯†é¡µé¢ä½ç½®å’Œç±»å‹
- **æ ‡é¢˜**ï¼šé¡µé¢å†…å®¹çš„æ¦‚æ‹¬
- **äº¤äº’å…ƒç´ **ï¼šå¯ç”¨çš„åŠ¨ä½œç©ºé—´
- **æ»šåŠ¨ä½ç½®**ï¼šé¡µé¢è§†å›¾çŠ¶æ€

#### 3.2.2 åµŒå…¥ç”Ÿæˆæµç¨‹
1. **æ•°æ®åŠ è½½**ï¼šåŒæ—¶è¯»å–è¯„åˆ†æ•°æ®å’ŒåŸå§‹ä¼šè¯æ•°æ®
2. **çŠ¶æ€æå–**ï¼šä»åŸå§‹æ•°æ®ä¸­æå–DOMçŠ¶æ€ä¿¡æ¯
3. **æ‰¹é‡åµŒå…¥**ï¼šä½¿ç”¨OpenAIçš„`text-embedding-3-large`æ¨¡å‹
4. **æ•°æ®æ•´åˆ**ï¼šå°†åµŒå…¥å‘é‡ä¸åŠ¨ä½œã€è¯„åˆ†ã€æƒ…å¢ƒæè¿°ç­‰ä¿¡æ¯åˆå¹¶

#### 3.2.3 è¾“å‡ºæ•°æ®ç»“æ„
```json
{
  "metadata": {
    "model": "text-embedding-3-large",
    "total_steps": 12,
    "source_files": {...}
  },
  "state_embeddings": [
    {
      "step_number": 1,
      "state_text": "URL: https://example.com\n...",
      "state_embedding": [3072ç»´å‘é‡],
      "action": [{"action_type": "click_element", ...}],
      "score": 3,
      "reasoning": "è¯¥åŠ¨ä½œæˆåŠŸå®šä½åˆ°ç›®æ ‡é¡µé¢",
      "situation": "åœ¨Googleæœç´¢é¡µé¢ï¼Œæœç´¢æ¡†å’ŒæŒ‰é’®å¯è§"
    }
  ]
}
```

#### 3.2.4 æŠ€æœ¯ç‰¹ç‚¹
- **é«˜ç»´å‘é‡**ï¼šä½¿ç”¨3072ç»´çš„text-embedding-3-largeæ¨¡å‹
- **æ‰¹é‡å¤„ç†**ï¼šä¸€æ¬¡APIè°ƒç”¨å¤„ç†æ‰€æœ‰æ­¥éª¤ï¼Œæé«˜æ•ˆç‡
- **ä¿¡æ¯å®Œæ•´**ï¼šä¿ç•™è¯„åˆ†ã€ç†ç”±ã€æƒ…å¢ƒç­‰æ‰€æœ‰ç›¸å…³ä¿¡æ¯
- **çµæ´»è®¾è®¡**ï¼šåµŒå…¥ä»…åŸºäºDOMçŠ¶æ€ï¼Œä½†è¾“å‡ºåŒ…å«å®Œæ•´ä¸Šä¸‹æ–‡

### 3.3 å‘é‡å­˜å‚¨ç³»ç»Ÿ

ç›®å‰ç³»ç»Ÿé‡‡ç”¨åŸºäºJSONæ–‡ä»¶çš„å‘é‡å­˜å‚¨æ–¹æ¡ˆï¼Œä¸ºåç»­å‡çº§åˆ°ä¸“ä¸šå‘é‡æ•°æ®åº“é¢„ç•™äº†æ¥å£ã€‚

#### 3.3.1 å­˜å‚¨æ ¼å¼è®¾è®¡
åµŒå…¥æ•°æ®ä»¥JSONæ ¼å¼å­˜å‚¨åœ¨`state_embedder/`ç›®å½•ä¸‹ï¼Œæ¯ä¸ªæ–‡ä»¶å¯¹åº”ä¸€ä¸ªå·²è¯„åˆ†çš„ä¼šè¯ï¼š

```json
{
  "metadata": {
    "model": "text-embedding-3-large",
    "total_steps": 15,
    "source_files": {
      "scored": "score_json/session_scored.json",
      "original": "json_logs/session.json"
    }
  },
  "state_embeddings": [
    {
      "step_number": 1,
      "state_text": "URL: https://example.com\n...",
      "state_embedding": [3072ç»´æµ®ç‚¹æ•°ç»„],
      "action": [{"action_type": "click_element", ...}],
      "score": 3,
      "reasoning": "è¯¥åŠ¨ä½œæˆåŠŸå®šä½åˆ°ç›®æ ‡é¡µé¢",
      "situation": "åœ¨Googleæœç´¢é¡µé¢ï¼Œæœç´¢æ¡†å’ŒæŒ‰é’®å¯è§",
      "thinking": "æˆ‘éœ€è¦å…ˆæœç´¢ç›¸å…³ä¿¡æ¯",
      "action_detail": "click_element: {'index': 5}"
    }
  ]
}
```

#### 3.3.2 æ•°æ®å®Œæ•´æ€§ä¿è¯
ç³»ç»Ÿåœ¨ç”ŸæˆåµŒå…¥æ—¶æ•´åˆå¤šä¸ªæ•°æ®æºï¼š
- **åŸå§‹ä¼šè¯æ•°æ®**ï¼šæå–thinkingå­—æ®µï¼Œä¿ç•™agentçš„åŸå§‹æ¨ç†è¿‡ç¨‹
- **è¯„åˆ†æ•°æ®**ï¼šè·å–scoreã€reasoningã€situationç­‰è¯„ä¼°ä¿¡æ¯
- **DOMçŠ¶æ€**ï¼šæ„å»ºæ ‡å‡†åŒ–çš„çŠ¶æ€æ–‡æœ¬è¡¨ç¤º

è¿™ç§è®¾è®¡ç¡®ä¿äº†æ£€ç´¢æ—¶èƒ½è·å¾—å®Œæ•´çš„å†å²ç»éªŒä¸Šä¸‹æ–‡ã€‚

## å››ã€æ£€ç´¢å¢å¼ºå±‚

æ£€ç´¢å¢å¼ºå±‚é€šè¿‡`ExperienceRetriever`ç±»å®ç°ï¼Œè´Ÿè´£åœ¨agentæ‰§è¡Œæ—¶æ£€ç´¢ç›¸ä¼¼çš„å†å²ç»éªŒï¼Œä¸ºå†³ç­–æä¾›å‚è€ƒã€‚

### 4.1 ç›¸ä¼¼æ€§åŒ¹é…

#### 4.1.1 çŠ¶æ€ç›¸ä¼¼åº¦è®¡ç®—
é‡‡ç”¨ä½™å¼¦ç›¸ä¼¼åº¦ä½œä¸ºç›¸ä¼¼æ€§åº¦é‡ï¼š
```python
def cosine_similarity(embedding1: List[float], embedding2: List[float]) -> float:
    """è®¡ç®—ä¸¤ä¸ªå‘é‡çš„ä½™å¼¦ç›¸ä¼¼åº¦"""
    dot_product = sum(a * b for a, b in zip(embedding1, embedding2))
    norm1 = math.sqrt(sum(a * a for a in embedding1))
    norm2 = math.sqrt(sum(b * b for b in embedding2))
    return dot_product / (norm1 * norm2) if norm1 * norm2 != 0 else 0
```

#### 4.1.2 æ£€ç´¢æµç¨‹è®¾è®¡
1. **å®æ—¶åµŒå…¥ç”Ÿæˆ**ï¼šå°†å½“å‰DOMçŠ¶æ€è½¬æ¢ä¸ºåµŒå…¥å‘é‡
2. **å¤šæ–‡ä»¶æ£€ç´¢**ï¼šéå†æ‰€æœ‰å†å²åµŒå…¥æ–‡ä»¶è®¡ç®—ç›¸ä¼¼åº¦
3. **ç»“æœèšåˆ**ï¼šæ”¶é›†æ‰€æœ‰ç›¸ä¼¼çŠ¶æ€å¹¶æ’åº
4. **Top-Ké€‰æ‹©**ï¼šè¿”å›ç›¸ä¼¼åº¦æœ€é«˜çš„Kä¸ªå†å²ç»éªŒ

#### 4.1.3 æ£€ç´¢ä¼˜åŒ–ç­–ç•¥
- **ç›¸ä¼¼åº¦é˜ˆå€¼**ï¼šåªè¿”å›ç›¸ä¼¼åº¦é«˜äºé˜ˆå€¼ï¼ˆé»˜è®¤0.7ï¼‰çš„ç»“æœ
- **è¯„åˆ†è¿‡æ»¤**ï¼šä¼˜å…ˆé€‰æ‹©é«˜åˆ†ï¼ˆscore > 0ï¼‰çš„å†å²ç»éªŒ
- **æ‰¹é‡è®¡ç®—**ï¼šé¢„åŠ è½½æ‰€æœ‰åµŒå…¥æ–‡ä»¶ï¼Œå‡å°‘I/Oå¼€é”€

### 4.2 ç»éªŒé›†æˆæœºåˆ¶

#### 4.2.1 å†å²ç»éªŒæ ¼å¼åŒ–
ç³»ç»Ÿå°†æ£€ç´¢åˆ°çš„å†å²ç»éªŒæ ¼å¼åŒ–ä¸ºç»“æ„åŒ–æ¶ˆæ¯ï¼š

```
## ğŸ“š Historical Experience Reference

Based on the current browser state, here are similar situations from past experiences:

**1. Similarity: 0.85**
- **Situation**: åœ¨Googleæœç´¢é¡µé¢ï¼Œæœç´¢æ¡†å’ŒæŒ‰é’®å¯è§
- **Action and intention**: click_element - æˆ‘éœ€è¦ç‚¹å‡»æœç´¢æ¡†è¾“å…¥æŸ¥è¯¢
- **Comment**: Score 3/5, è¯¥åŠ¨ä½œæˆåŠŸå®šä½åˆ°æœç´¢æ¡†ï¼Œä¸ºåç»­è¾“å…¥åšå¥½å‡†å¤‡

**2. Similarity: 0.82**
- **Situation**: æœç´¢ç»“æœé¡µé¢æ˜¾ç¤ºå¤šä¸ªé“¾æ¥
- **Action and intention**: scroll_down - éœ€è¦å‘ä¸‹æ»šåŠ¨æŸ¥çœ‹æ›´å¤šç»“æœ
- **Comment**: Score 2/5, å¸¸è§„æ»šåŠ¨æ“ä½œï¼Œæœ‰æ•ˆä½†æ•ˆç‡ä¸€èˆ¬
```

#### 4.2.2 ç³»ç»Ÿæç¤ºè¯é›†æˆ
åœ¨`system_prompt.md`ä¸­æ·»åŠ äº†å†å²ç»éªŒæŒ‡å¯¼ï¼š

```markdown
<historical_experience_guidance>
You may receive historical experience from similar past situations. These experiences include:
- **Situation**: The context/state when the action was taken
- **Action and intention**: What action was taken and why
- **Comment**: Score (-5 to +5) and reasoning for the action's effectiveness

Score interpretation:
- **+4 to +5**: Excellent actions that made breakthrough progress
- **+1 to +3**: Positive actions with varying degrees of usefulness
- **0**: Neutral actions with no significant impact
- **-1 to -3**: Inefficient or wrong actions to avoid
- **-4 to -5**: Harmful actions that caused significant problems

Use high-scoring experiences as positive examples and low-scoring ones as warnings.
</historical_experience_guidance>
```

### 4.3 å®æ—¶æ£€ç´¢é›†æˆ

#### 4.3.1 æ£€ç´¢è§¦å‘æ—¶æœº
åœ¨agentä¸»å¾ªç¯ä¸­ï¼Œæ¯ä¸ªæ­¥éª¤å¼€å§‹å‰è§¦å‘ç»éªŒæ£€ç´¢ï¼š

```python
# åœ¨browser_use/agent/service.pyçš„runæ–¹æ³•ä¸­
if self.experience_retriever and browser_state_summary:
    # åˆ›å»ºå½“å‰çŠ¶æ€çš„åµŒå…¥
    current_state_embedding = await self.experience_retriever.create_state_embedding(
        browser_state_summary
    )
    
    # æ£€ç´¢ç›¸ä¼¼å†å²çŠ¶æ€
    similar_states = self.experience_retriever.retrieve_similar_states(
        current_state_embedding,
        top_k=self.settings.experience_top_k,
        similarity_threshold=self.settings.experience_similarity_threshold
    )
    
    if similar_states:
        # æ ¼å¼åŒ–å¹¶æ·»åŠ åˆ°æ¶ˆæ¯å†å²
        experience_message = self.experience_retriever.format_experience_message(similar_states)
        self._message_manager._add_message_with_tokens(
            HumanMessage(content=experience_message)
        )
```

#### 4.3.2 æ€§èƒ½è€ƒè™‘
- **å¼‚æ­¥å¤„ç†**ï¼šåµŒå…¥ç”Ÿæˆä½¿ç”¨å¼‚æ­¥APIè°ƒç”¨
- **ç¼“å­˜æœºåˆ¶**ï¼šè€ƒè™‘å¯¹é¢‘ç¹è®¿é—®çš„åµŒå…¥è¿›è¡Œå†…å­˜ç¼“å­˜
- **æ‡’åŠ è½½**ï¼šåªåœ¨å¯ç”¨ç»éªŒæ£€ç´¢æ—¶åŠ è½½å†å²æ•°æ®

## äº”ã€ç³»ç»Ÿé›†æˆä¸ä¼˜åŒ–

### 5.1 é…ç½®ç®¡ç†

#### 5.1.1 Agenté…ç½®æ‰©å±•
åœ¨`AgentSettings`ä¸­æ·»åŠ äº†å¼ºåŒ–å­¦ä¹ ç›¸å…³é…ç½®ï¼š

```python
class AgentSettings(BaseModel):
    # å†å²ç»éªŒæ£€ç´¢è®¾ç½®
    enable_experience_retrieval: bool = False
    embeddings_file: str | None = None  # æŒ‡å®šç‰¹å®šçš„åµŒå…¥æ–‡ä»¶
    experience_similarity_threshold: float = 0.7
    experience_top_k: int = 5
```

#### 5.1.2 ä½¿ç”¨ç¤ºä¾‹
```python
agent = Agent(
    browser=browser,
    task="å®ŒæˆæŸä¸ªä»»åŠ¡",
    enable_experience_retrieval=True,
    experience_similarity_threshold=0.75,
    experience_top_k=3
)
```

### 5.2 æ¨¡å‹ä¼˜åŒ–ä¸é€‰æ‹©

#### 5.2.1 è¯„åˆ†æ¨¡å‹å¯¹æ¯”
é€šè¿‡å®é™…æµ‹è¯•ï¼Œæˆ‘ä»¬å¯¹æ¯”äº†å¤šä¸ªLLMçš„è¯„åˆ†æ•ˆæœï¼š

| æ¨¡å‹ | ä¼˜ç‚¹ | ç¼ºç‚¹ | æ¨èåº¦ |
|------|------|------|--------|
| GPT-4o-mini | å“åº”å¿«ï¼Œæˆæœ¬ä½ | è¯„åˆ†ç›¸å¯¹å®½æ¾ | â˜…â˜…â˜…â˜†â˜† |
| Claude-3 | è¯„åˆ†åˆç†ï¼Œè§£é‡Šè¯¦ç»† | æˆæœ¬è¾ƒé«˜ | â˜…â˜…â˜…â˜…â˜† |
| Gemini-2.5-pro | é”™è¯¯è¯†åˆ«å‡†ç¡®ï¼Œè¯„åˆ†ä¸¥æ ¼ | éœ€å¤„ç†JSONæ ¼å¼é—®é¢˜ | â˜…â˜…â˜…â˜…â˜… |

**Gemini-2.5-proçš„ç‰¹æ®Šå¤„ç†ï¼š**
```python
# å¤„ç†Geminiè¿”å›çš„markdownåŒ…è£…JSON
content = response.content.strip()
if content.startswith('```json'):
    content = content[7:]  # ç§»é™¤ ```json
    if content.endswith('```'):
        content = content[:-3]  # ç§»é™¤ç»“å°¾çš„ ```
```

#### 5.2.2 åµŒå…¥æ¨¡å‹é€‰æ‹©
ä½¿ç”¨OpenAIçš„`text-embedding-3-large`æ¨¡å‹ï¼š
- **ç»´åº¦**ï¼š3072ç»´ï¼Œæä¾›ä¸°å¯Œçš„è¯­ä¹‰ä¿¡æ¯
- **æ€§èƒ½**ï¼šåœ¨ç›¸ä¼¼åº¦åŒ¹é…ä¸Šè¡¨ç°ä¼˜ç§€
- **æˆæœ¬**ï¼šç›¸å¯¹åˆç†ï¼Œæ”¯æŒæ‰¹é‡å¤„ç†

### 5.3 å·²çŸ¥é—®é¢˜ä¸æ”¹è¿›

#### 5.3.1 Conversation Logç´¯ç§¯é—®é¢˜
**é—®é¢˜æè¿°ï¼š**
åŸé¡¹ç›®çš„conversationä¿å­˜æœºåˆ¶å­˜åœ¨ç´¯ç§¯é—®é¢˜ï¼Œæ¯ä¸ªæ­¥éª¤çš„æ—¥å¿—æ–‡ä»¶åŒ…å«äº†æ‰€æœ‰ä¹‹å‰æ­¥éª¤çš„å†å²ã€‚

**é—®é¢˜æ ¹æºï¼š**
```python
# browser_use/agent/service.py ç¬¬1007è¡Œ
input_messages = self._message_manager.get_messages()  # è·å–æ‰€æœ‰ç´¯ç§¯æ¶ˆæ¯

# ç¬¬1054è¡Œ
await save_conversation(
    input_messages,  # åŒ…å«å…¨éƒ¨å†å²
    model_output, 
    target
)
```

**å»ºè®®è§£å†³æ–¹æ¡ˆï¼š**
1. åœ¨`MessageManager`ä¸­æ·»åŠ `get_current_step_messages()`æ–¹æ³•
2. ä¿å­˜æ—¶åªåŒ…å«å½“å‰æ­¥éª¤çš„ç›¸å…³æ¶ˆæ¯
3. ä¿æŒLLMè°ƒç”¨æ—¶çš„å®Œæ•´ä¸Šä¸‹æ–‡ä¸å˜

#### 5.3.2 æ•°æ®å¤„ç†ä¼˜åŒ–å»ºè®®
1. **å¹¶è¡Œå¤„ç†**ï¼šè¯„åˆ†å’ŒåµŒå…¥ç”Ÿæˆå¯ä»¥å¹¶è¡ŒåŒ–
2. **å¢é‡æ›´æ–°**ï¼šåªå¤„ç†æ–°å¢çš„ä¼šè¯æ•°æ®
3. **å­˜å‚¨ä¼˜åŒ–**ï¼šè€ƒè™‘å‹ç¼©å­˜å‚¨å†å²åµŒå…¥æ•°æ®

## å…­ã€æŠ€æœ¯å®ç°æ€»ç»“

### 6.1 æ ¸å¿ƒç»„ä»¶æ¶æ„

#### 6.1.1 ActionScorerï¼ˆåŠ¨ä½œè¯„åˆ†å™¨ï¼‰
**èŒè´£**ï¼šå¯¹å†å²ä¼šè¯çš„æ¯ä¸ªåŠ¨ä½œè¿›è¡Œè´¨é‡è¯„åˆ†
- **è¾“å…¥**ï¼šJSONæ ¼å¼çš„ä¼šè¯æ—¥å¿—
- **è¾“å‡º**ï¼šåŒ…å«è¯„åˆ†å’Œåˆ†æçš„å¢å¼ºJSON
- **ç‰¹ç‚¹**ï¼šæ‰¹é‡è¯„åˆ†ã€å¤šæ¨¡å‹æ”¯æŒã€ç»“æ„åŒ–è¾“å‡º

#### 6.1.2 StateEmbedderï¼ˆçŠ¶æ€åµŒå…¥å™¨ï¼‰
**èŒè´£**ï¼šå°†DOMçŠ¶æ€è½¬æ¢ä¸ºå‘é‡è¡¨ç¤º
- **è¾“å…¥**ï¼šè¯„åˆ†åçš„ä¼šè¯æ•°æ® + åŸå§‹ä¼šè¯æ•°æ®
- **è¾“å‡º**ï¼šåŒ…å«åµŒå…¥å‘é‡çš„JSONæ–‡ä»¶
- **ç‰¹ç‚¹**ï¼šä¿¡æ¯æ•´åˆã€æ‰¹é‡å¤„ç†ã€é«˜ç»´åµŒå…¥

#### 6.1.3 ExperienceRetrieverï¼ˆç»éªŒæ£€ç´¢å™¨ï¼‰
**èŒè´£**ï¼šæ£€ç´¢å¹¶æ ¼å¼åŒ–ç›¸ä¼¼çš„å†å²ç»éªŒ
- **è¾“å…¥**ï¼šå½“å‰DOMçŠ¶æ€
- **è¾“å‡º**ï¼šæ ¼å¼åŒ–çš„å†å²ç»éªŒæ¶ˆæ¯
- **ç‰¹ç‚¹**ï¼šå®æ—¶æ£€ç´¢ã€ç›¸ä¼¼åº¦è®¡ç®—ã€çµæ´»è¿‡æ»¤

### 6.2 æ•°æ®æµè½¬ç®¡é“

```
åŸå§‹æ—¥å¿— â†’ åŠ¨ä½œè¯„åˆ† â†’ çŠ¶æ€åµŒå…¥ â†’ ç»éªŒæ£€ç´¢ â†’ Agentå†³ç­–å¢å¼º
   â†“           â†“           â†“           â†“              â†“
json_logs  score_json  state_embedder  runtime    improved actions
```

### 6.3 å…³é”®è®¾è®¡å†³ç­–

1. **è¯„åˆ†èŒƒå›´é€‰æ‹©ï¼ˆ-5åˆ°+5ï¼‰**ï¼š
   - 11ä¸ªç¦»æ•£çº§åˆ«æä¾›è¶³å¤Ÿçš„åŒºåˆ†åº¦
   - é¿å…è¿‡äºç»†ç²’åº¦çš„è¯„åˆ†å¸¦æ¥çš„ä¸ä¸€è‡´æ€§
   - ä¾¿äºLLMç†è§£å’Œåº”ç”¨

2. **JSONæ–‡ä»¶å­˜å‚¨æ–¹æ¡ˆ**ï¼š
   - ç®€å•å¯é ï¼Œæ˜“äºè°ƒè¯•å’Œäººå·¥æ£€æŸ¥
   - æ— éœ€é¢å¤–çš„æ•°æ®åº“ä¾èµ–
   - ä¸ºæœªæ¥å‡çº§åˆ°å‘é‡æ•°æ®åº“é¢„ç•™æ¥å£

3. **æ‰¹é‡å¤„ç†ç­–ç•¥**ï¼š
   - å‡å°‘APIè°ƒç”¨æ¬¡æ•°ï¼Œé™ä½æˆæœ¬
   - ä¿è¯åŒä¸€ä¼šè¯çš„è¯„åˆ†ä¸€è‡´æ€§
   - æé«˜æ•´ä½“å¤„ç†æ•ˆç‡

4. **ä¿¡æ¯å®Œæ•´æ€§è®¾è®¡**ï¼š
   - ä¿ç•™thinkingã€situationç­‰å…³é”®ä¸Šä¸‹æ–‡
   - æ”¯æŒå¤šç»´åº¦çš„ç»éªŒåˆ†æ
   - ä¾¿äºè°ƒè¯•å’Œæ•ˆæœè¯„ä¼°

## ä¸ƒã€ä½¿ç”¨æŒ‡å—

### 7.1 å¿«é€Ÿå¼€å§‹

#### 7.1.1 å¤„ç†å†å²æ•°æ®
```bash
# 1. å¯¹ä¼šè¯è¿›è¡Œè¯„åˆ†
python action_scorer.py json_logs/session_20250117.json --model gemini-2.5-pro

# 2. ç”ŸæˆçŠ¶æ€åµŒå…¥
python state_embedder.py score_json/session_20250117_scored.json

# 3. å¯ç”¨ç»éªŒæ£€ç´¢è¿è¡Œagent
agent = Agent(
    task="your task",
    enable_experience_retrieval=True
)
```

#### 7.1.2 é…ç½®æ–‡ä»¶ç¤ºä¾‹
```python
# api_key.py
Openrouter_API_KEY = "your-api-key"
Openrouter_BASE_URL = "https://openrouter.ai/api/v1"
```

### 7.2 æœ€ä½³å®è·µ

1. **æ•°æ®æ”¶é›†é˜¶æ®µ**ï¼š
   - æ”¶é›†å¤šæ ·åŒ–çš„ä»»åŠ¡æ‰§è¡Œæ•°æ®
   - ç¡®ä¿åŒ…å«æˆåŠŸå’Œå¤±è´¥çš„æ¡ˆä¾‹
   - å®šæœŸæ¸…ç†ä½è´¨é‡æ•°æ®

2. **è¯„åˆ†é˜¶æ®µ**ï¼š
   - ä½¿ç”¨Gemini-2.5-proè·å¾—æœ€ä½³è¯„åˆ†è´¨é‡
   - æ‰¹é‡å¤„ç†ç›¸å…³ä»»åŠ¡çš„ä¼šè¯
   - äººå·¥æŠ½æŸ¥è¯„åˆ†åˆç†æ€§

3. **åº”ç”¨é˜¶æ®µ**ï¼š
   - å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯æ•ˆæœ
   - é€æ­¥è°ƒæ•´ç›¸ä¼¼åº¦é˜ˆå€¼
   - ç›‘æ§æ£€ç´¢çš„ç»éªŒè´¨é‡

## å…«ã€æ€»ç»“ä¸å±•æœ›

### 8.1 ç³»ç»Ÿæˆæœ

æœ¬å¼ºåŒ–å­¦ä¹ å¢å¼ºç³»ç»ŸæˆåŠŸå®ç°äº†ï¼š

1. **å®Œæ•´çš„æ•°æ®ç®¡é“**ï¼šä»æ—¥å¿—æ”¶é›†åˆ°ç»éªŒåº”ç”¨çš„å…¨æµç¨‹
2. **çµæ´»çš„è¯„åˆ†æœºåˆ¶**ï¼šæ”¯æŒå¤šæ¨¡å‹ã€æ‰¹é‡å¤„ç†ã€ç»“æ„åŒ–è¾“å‡º
3. **é«˜æ•ˆçš„æ£€ç´¢ç³»ç»Ÿ**ï¼šåŸºäºè¯­ä¹‰ç›¸ä¼¼åº¦çš„å†å²ç»éªŒæ£€ç´¢
4. **æ— ç¼çš„é›†æˆæ–¹æ¡ˆ**ï¼šæœ€å°åŒ–å¯¹åŸç³»ç»Ÿçš„æ”¹åŠ¨

### 8.2 æ•ˆæœé¢„æœŸ

- **ä»»åŠ¡æˆåŠŸç‡æå‡**ï¼šé€šè¿‡å­¦ä¹ å†å²ç»éªŒé¿å…é‡å¤é”™è¯¯
- **æ‰§è¡Œæ•ˆç‡ä¼˜åŒ–**ï¼šå‚è€ƒé«˜åˆ†åŠ¨ä½œé€‰æ‹©æ›´ä¼˜è·¯å¾„
- **é”™è¯¯æ¢å¤èƒ½åŠ›**ï¼šä»å¤±è´¥ç»éªŒä¸­å­¦ä¹ æ¢å¤ç­–ç•¥

### 8.3 æœªæ¥å‘å±•æ–¹å‘

1. **å‘é‡æ•°æ®åº“å‡çº§**ï¼š
   - è¿ç§»åˆ°ä¸“ä¸šå‘é‡æ•°æ®åº“ï¼ˆå¦‚Milvusã€Pineconeï¼‰
   - æ”¯æŒæ›´å¤§è§„æ¨¡çš„å†å²æ•°æ®
   - æä¾›æ›´å¿«çš„æ£€ç´¢é€Ÿåº¦

2. **åœ¨çº¿å­¦ä¹ æœºåˆ¶**ï¼š
   - å®æ—¶è¯„åˆ†å’Œæ›´æ–°
   - è‡ªåŠ¨è¯†åˆ«æ–°æ¨¡å¼
   - åŠ¨æ€è°ƒæ•´æ£€ç´¢ç­–ç•¥

3. **å¤šä»»åŠ¡çŸ¥è¯†è¿ç§»**ï¼š
   - è·¨ä»»åŠ¡çš„ç»éªŒå…±äº«
   - é€šç”¨åŠ¨ä½œæ¨¡å¼æå–
   - é¢†åŸŸç‰¹å®šçŸ¥è¯†åº“

4. **è¯„ä¼°ä½“ç³»å®Œå–„**ï¼š
   - A/Bæµ‹è¯•æ¡†æ¶
   - æ•ˆæœé‡åŒ–æŒ‡æ ‡
   - æŒç»­ä¼˜åŒ–å¾ªç¯

é€šè¿‡è¿™ä¸ªå¼ºåŒ–å­¦ä¹ ç³»ç»Ÿï¼ŒBrowser-Useä»ä¸€ä¸ª"æ— è®°å¿†"çš„è‡ªåŠ¨åŒ–å·¥å…·è¿›åŒ–ä¸ºèƒ½å¤Ÿä»ç»éªŒä¸­å­¦ä¹ çš„æ™ºèƒ½agentï¼Œä¸ºå¤æ‚çš„Webè‡ªåŠ¨åŒ–ä»»åŠ¡æä¾›äº†æ›´å¯é å’Œé«˜æ•ˆçš„è§£å†³æ–¹æ¡ˆã€‚